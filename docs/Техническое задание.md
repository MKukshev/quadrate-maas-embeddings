# Техническое задание: quadrate-maas-embeddings

## 1. Введение
Необходимо реализовать сервис Model-as-a-Service (MaaS) для:
- генерации эмбеддингов (embeddings) из текста,
- reranking (cross-encoder rerank) списка документов по запросу.

Сервис должен иметь единую точку входа (Router/Gateway) и маршрутизировать запросы по полю `model` в соответствующие backend-сервисы.

MVP разворачивается без Kubernetes (Docker Compose) и должен быть спроектирован так, чтобы миграция в Kubernetes была механической (замена `deploy/compose` на `deploy/k8s` без изменения кода и API).

## 2. Термины
- Router/Gateway: внешний API сервис, принимает запросы клиентов и проксирует их в upstream.
- Upstream: внутренний backend сервис (Infinity embeddings, rerank сервис, Qwen3 экспериментальный сервис).
- Model ID: строковый идентификатор модели, указываемый клиентом в запросе.

## 3. Цели и ограничения MVP
### 3.1 Цели
- Единый API: `/v1/embeddings`, `/v1/rerank`.
- Поддержка нескольких embedding-моделей одновременно (multi-model).
- Прозрачная замена/добавление моделей через конфигурацию (без перекомпиляции/перепаковки Router).
- Базовая безопасность (API key), rate limiting.
- Наблюдаемость: метрики Prometheus, структурированные логи, request id.

### 3.2 Ограничения MVP
- Peak нагрузка: до 5 QPS (embeddings и rerank).
- `top_k` для rerank: по умолчанию 20, увеличиваем позже через конфиг и ресурсы.
- Qwen3-Embedding-8B используется ТОЛЬКО для экспериментов, выключен по умолчанию.

## 4. Архитектура решения
### 4.1 Компоненты
1) Router/Gateway (обязательный)
- Внешний порт: 8080.
- Функции:
  - Валидация входных запросов.
  - Роутинг по `model` на upstream.
  - API key auth (header `X-API-Key`).
  - Rate limiting (минимальный token bucket).
  - Метрики (Prometheus).
  - Health endpoints: liveness/readiness.
  - Endpoint `/v1/models` — список моделей и их статуса из routing-конфига.

2) Infinity embeddings (обязательный)
- Один инстанс, обслуживающий несколько embedding-моделей одновременно:
  - `ai-forever/FRIDA`
  - `BAAI/bge-m3`
  - `intfloat/multilingual-e5-large`

3) Rerank сервис (обязательный)
- Отдельный сервис, обслуживающий модель:
  - `BAAI/bge-reranker-v2-m3`
- MVP: CPU режим (без GPU) допускается.

4) Qwen3 embedding (опционально, эксперимент)
- Отдельный сервис `Qwen3-Embedding-8B`.
- Включается только в экспериментальном профиле (compose override / config flag).

### 4.2 Внешний контракт API
Внешний контракт должен соответствовать `api/openapi.yaml`.
Обязательные endpoints:
- `POST /v1/embeddings`
- `POST /v1/rerank`
- `GET /v1/models`
- `GET /health/live`
- `GET /health/ready`
- `GET /metrics`

### 4.3 Конфигурация роутинга (routing.yaml)
Router читает конфигурацию `configs/routing.yaml` (путь задаётся env).
В конфиге задаётся:
- тип (embeddings/rerank),
- provider,
- url upstream,
- timeout_ms,
- enabled (для экспериментальных моделей),
- default_top_k и max_top_k для rerank.

Router обязан:
- возвращать 400 при неизвестной модели,
- возвращать 503/400 при `enabled:false`,
- валидировать `top_k <= max_top_k`.

## 5. Нефункциональные требования
### 5.1 Надёжность
- Router должен быть stateless.
- Все ошибки upstream должны корректно отражаться клиенту (502/503) с ErrorResponse.
- Таймауты на upstream обязательны (httpx timeout).

### 5.2 Наблюдаемость
- Prometheus метрики на `/metrics`:
  - HTTP requests total, latency histogram.
  - Upstream latency и upstream errors.
  - Rate limit drops.
- Корреляция: `X-Request-Id` поддержать как входящий/исходящий заголовок.
- Логи: JSON structured logs (request_id, path, model, status, latency_ms, upstream).

### 5.3 Безопасность
- Простая аутентификация API key:
  - `X-API-Key` сверяется со списком ключей в `configs/auth.yaml` или через env.
- Rate limiting по API key (минимально: глобальный, затем расширяем до per-key).

### 5.4 Производительность (MVP ориентиры)
- На 5 QPS система должна работать без деградации и с error rate < 1%.
- Целевые SLO по latency на MVP не фиксируются, но p50/p95 должны измеряться и логироваться.

## 6. Реализация: технологии и стандарты
### 6.1 Язык и фреймворки
- Python 3.11+
- Router: FastAPI + Uvicorn
- HTTP клиент: httpx
- Конфиги: PyYAML
- Метрики: prometheus_client
- Тесты: pytest (+ httpx mock)

### 6.2 Репозиторий и структура
Реализовать структуру:
- `services/router` — исходники Router
- `services/rerank` — rerank backend
- `deploy/compose` — docker compose
- `deploy/k8s` — Helm skeleton (может быть минимальным на MVP)
- `configs/*` — routing/auth/rate limits
- `api/openapi.yaml` — внешний контракт
- `scripts/*` — smoke test и benchmark

## 7. Router: требования к реализации
### 7.1 Основные модули
- settings.py: env, пути к конфигам
- routing.py: загрузка/валидация routing.yaml, выбор upstream
- auth.py: API key middleware
- ratelimit.py: token bucket (MVP)
- metrics.py: Prometheus
- upstream/clients: адаптеры под providers (infinity, rerank, qwen3)

### 7.2 Обработка /v1/embeddings
- Валидация:
  - model не пустой
  - input: string или array[string]
- Роутинг:
  - определить provider по model
  - вызвать соответствующий upstream client
- Ответ:
  - привести к единому формату EmbeddingsResponse (как в OpenAPI)

### 7.3 Обработка /v1/rerank
- Валидация:
  - documents >= 1
  - top_k: default 20; не превышает max_top_k из routing.yaml
- Вызов rerank upstream
- Ответ:
  - вернуть RerankResponse по OpenAPI
  - если return_documents=true — включить document в results (иначе null)

### 7.4 Ошибки (единый формат)
Возвращать ErrorResponse:
- code: invalid_request / unauthorized / rate_limited / upstream_unavailable / internal_error
- message: человекочитаемо
- details: контекст
- request_id

Статусы:
- 400: invalid payload / unknown model / top_k out of bounds
- 401: invalid API key
- 429: rate limit
- 499: client disconnected before completion
- 502: upstream returned error (4xx/5xx), если это не таймаут
- 503: upstream timeout / connection error

### 7.5 Health
- `/health/live`: всегда ok если процесс жив
- `/health/ready`: проверяет доступность ключевых upstream:
  - infinity-embed
  - rerank
  - qwen3 (если enabled)
Статус: ok или degraded. Если обязательный upstream недоступен — degraded.

## 8. Rerank сервис: требования к реализации
### 8.1 API
- `POST /v1/rerank` (внутренний сервис, вызывается Router)
- `GET /health/live`, `GET /health/ready`
- `GET /metrics`

### 8.2 Логика
- Загрузить модель `BAAI/bge-reranker-v2-m3` один раз при старте (или lazy + warmup).
- Принимать query и массив documents.
- Считать score для каждого документа, отсортировать по убыванию, вернуть top_k.

### 8.3 Ограничения
- Ввести ограничение на размер documents (например max 200) и/или суммарную длину (чтобы не убить CPU).
- Эти ограничения должны быть параметризуемы env.

## 9. Infinity embeddings: интеграция
- В Docker Compose поднять Infinity embeddings в режиме multi-model с 3 моделями.
- Router должен корректно адресовать модель в запросе к Infinity (если требуется — маппинг model-id/served-name).

Примечание: конкретный URL/путь Infinity endpoint может отличаться. Реализация должна быть через адаптер upstream/infinity.py, чтобы смена пути не ломала Router.

## 10. Эксперимент Qwen3-Embedding-8B
- Реализовать как опциональный сервис, включаемый через compose override.
- В routing.yaml `enabled:false` по умолчанию.
- Router должен уметь корректно скрывать/показывать модель в `/v1/models`.

## 11. Docker Compose: требования
### 11.1 Базовый профиль (MVP)
- router
- infinity-embed
- rerank (cpu)

### 11.2 Экспериментальный профиль
- + qwen3-embed

### 11.3 Скрипты
- `scripts/smoke_test.sh`:
  - проверка health
  - embeddings запросы по 3 моделям
  - rerank запрос (top_k=20, 20 документов)
- `scripts/bench/*`:
  - нагрузка 5 QPS (k6 или locust), вывод p50/p95 и ошибок

## 12. Kubernetes (после MVP)
- Подготовить Helm skeleton:
  - router chart
  - infinity-embed chart
  - rerank chart
  - qwen3-embed chart (optional)
- ConfigMap/Secret для configs.
- Ingress для router.
- MIG/ресурсы: значения задаются в values.yaml (на MVP достаточно шаблонов без жёсткой привязки).

## 13. Критерии приёмки MVP
1) `docker compose up -d` поднимает стек без ошибок.
2) `POST /v1/embeddings` работает для:
   - ai-forever/FRIDA
   - BAAI/bge-m3
   - intfloat/multilingual-e5-large
3) `POST /v1/rerank` возвращает корректный top_k=20 результат.
4) `/v1/models` возвращает список моделей из routing.yaml и корректный enabled статус.
5) `/metrics` отдаёт метрики Router и Rerank.
6) На 5 QPS:
   - error rate < 1%
   - latency p50/p95 измеряется и логируется.
7) Qwen3 включается через compose override и не влияет на базовый профиль.

## 14. Итоговые deliverables (что Codex должен создать)
- Полный репозиторий `quadrate-maas-embeddings` со структурой.
- Реализация Router и Rerank сервисов.
- Конфиги routing/auth/rate_limits.
- OpenAPI файл в `api/openapi.yaml`.
- Docker Compose (базовый + экспериментальный override).
- Smoke test и benchmark скрипты.
- Минимальная документация (architecture.md, api.md, runbook.md).
