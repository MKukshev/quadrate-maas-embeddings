openapi: 3.1.0
info:
  title: quadrate-maas-embeddings
  version: 0.1.0
  description: >
    Model-as-a-Service API для Embeddings и Rerank.
    Единая точка входа, роутинг по model на upstream (Infinity / Rerank / Qwen3 optional).
servers:
  - url: http://localhost:8080
    description: Local (Docker Compose)
tags:
  - name: health
  - name: models
  - name: embeddings
  - name: rerank
  - name: metrics

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key

  headers:
    X-Request-Id:
      schema:
        type: string
      description: >
        Correlation ID запроса. Если не задан клиентом, генерируется сервером.

  schemas:
    ErrorResponse:
      type: object
      required: [error]
      properties:
        error:
          type: object
          required: [code, message]
          properties:
            code:
              type: string
              examples: ["invalid_request", "unauthorized", "rate_limited", "upstream_unavailable", "internal_error"]
            message:
              type: string
            details:
              type: object
              additionalProperties: true
            request_id:
              type: string

    HealthResponse:
      type: object
      required: [status]
      properties:
        status:
          type: string
          enum: ["ok"]

    ReadyResponse:
      type: object
      required: [status, upstream]
      properties:
        status:
          type: string
          enum: ["ok", "degraded"]
        upstream:
          type: object
          additionalProperties:
            type: object
            required: [status]
            properties:
              status:
                type: string
                enum: ["ok", "down"]
              message:
                type: string

    ModelInfo:
      type: object
      required: [id, type, enabled]
      properties:
        id:
          type: string
          description: Model identifier used in requests
        type:
          type: string
          enum: ["embeddings", "rerank"]
        provider:
          type: string
          description: Provider name (infinity/rerank/qwen3/etc.)
        enabled:
          type: boolean
        default_top_k:
          type: integer
          nullable: true
        max_top_k:
          type: integer
          nullable: true

    ModelsListResponse:
      type: object
      required: [object, data]
      properties:
        object:
          type: string
          enum: ["list"]
        data:
          type: array
          items:
            $ref: "#/components/schemas/ModelInfo"

    # ---------- Embeddings ----------
    EmbeddingsRequest:
      type: object
      required: [model, input]
      properties:
        model:
          type: string
          description: Model id
          examples: ["ai-forever/FRIDA", "BAAI/bge-m3", "intfloat/multilingual-e5-large", "Qwen3-Embedding-8B"]
        input:
          description: Text input(s) to embed
          oneOf:
            - type: string
            - type: array
              items:
                type: string
        encoding_format:
          type: string
          description: Optional, for compatibility (kept as "float")
          enum: ["float"]
          default: "float"
        user:
          type: string
          description: Optional client/user id for analytics
          nullable: true
        metadata:
          type: object
          description: Optional arbitrary metadata (passed through / logged)
          additionalProperties: true

    EmbeddingObject:
      type: object
      required: [object, index, embedding]
      properties:
        object:
          type: string
          enum: ["embedding"]
        index:
          type: integer
          minimum: 0
        embedding:
          type: array
          items:
            type: number

    Usage:
      type: object
      required: [prompt_tokens, total_tokens]
      properties:
        prompt_tokens:
          type: integer
          minimum: 0
        total_tokens:
          type: integer
          minimum: 0

    EmbeddingsResponse:
      type: object
      required: [object, model, data, usage]
      properties:
        object:
          type: string
          enum: ["list"]
        model:
          type: string
        data:
          type: array
          items:
            $ref: "#/components/schemas/EmbeddingObject"
        usage:
          $ref: "#/components/schemas/Usage"

    # ---------- Rerank ----------
    RerankDocument:
      type: object
      required: [text]
      properties:
        id:
          type: string
          nullable: true
        text:
          type: string
        metadata:
          type: object
          additionalProperties: true

    RerankRequest:
      type: object
      required: [model, query, documents]
      properties:
        model:
          type: string
          examples: ["BAAI/bge-reranker-v2-m3"]
        query:
          type: string
        documents:
          type: array
          minItems: 1
          items:
            oneOf:
              - type: string
              - $ref: "#/components/schemas/RerankDocument"
        top_k:
          type: integer
          minimum: 1
          maximum: 100
          default: 20
          description: For MVP default 20, upper bound controlled by routing.yaml (max_top_k)
        return_documents:
          type: boolean
          default: false
          description: If true, include document text/metadata in results (may increase response size)
        metadata:
          type: object
          additionalProperties: true

    RerankResult:
      type: object
      required: [index, score]
      properties:
        index:
          type: integer
          minimum: 0
          description: Index of the original documents array
        score:
          type: number
        document:
          oneOf:
            - $ref: "#/components/schemas/RerankDocument"
            - type: string
          nullable: true

    RerankResponse:
      type: object
      required: [model, top_k, results]
      properties:
        model:
          type: string
        top_k:
          type: integer
        results:
          type: array
          items:
            $ref: "#/components/schemas/RerankResult"

paths:
  /health/live:
    get:
      tags: [health]
      summary: Liveness probe
      responses:
        "200":
          description: Alive
          headers:
            X-Request-Id:
              $ref: "#/components/headers/X-Request-Id"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"

  /health/ready:
    get:
      tags: [health]
      summary: Readiness probe (checks upstream)
      responses:
        "200":
          description: Ready or degraded
          headers:
            X-Request-Id:
              $ref: "#/components/headers/X-Request-Id"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReadyResponse"

  /v1/models:
    get:
      tags: [models]
      summary: List available models from routing configuration
      security:
        - ApiKeyAuth: []
      responses:
        "200":
          description: Models list
          headers:
            X-Request-Id:
              $ref: "#/components/headers/X-Request-Id"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ModelsListResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /v1/embeddings:
    post:
      tags: [embeddings]
      summary: Create embeddings for input text(s)
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/EmbeddingsRequest"
      responses:
        "200":
          description: Embeddings response
          headers:
            X-Request-Id:
              $ref: "#/components/headers/X-Request-Id"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EmbeddingsResponse"
        "400":
          description: Invalid request / unknown model / disabled model
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "429":
          description: Rate limited
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "502":
          description: Upstream error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "503":
          description: Upstream unavailable / timeout
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /v1/rerank:
    post:
      tags: [rerank]
      summary: Rerank documents for a query
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RerankRequest"
      responses:
        "200":
          description: Rerank response
          headers:
            X-Request-Id:
              $ref: "#/components/headers/X-Request-Id"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RerankResponse"
        "400":
          description: Invalid request / unknown model / top_k exceeds max
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "429":
          description: Rate limited
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "502":
          description: Upstream error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "503":
          description: Upstream unavailable / timeout
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /metrics:
    get:
      tags: [metrics]
      summary: Prometheus metrics (text/plain)
      responses:
        "200":
          description: Metrics
          content:
            text/plain:
              schema:
                type: string